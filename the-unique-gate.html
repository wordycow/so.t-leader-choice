<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>The Unique – Gate</title>

  <!-- 공유 썸네일 -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="The Unique – 초대 전용 게이트">
  <meta property="og:description" content="Invitation-only access for action takers.">
  <meta property="og:url" content="https://wordycow.github.io/so.t-leader-choice/the-unique-gate.html">
  <meta property="og:image" content="https://wordycow.github.io/so.t-leader-choice/img/the-unique-gate-preview.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="The Unique – 초대 전용 게이트">
  <meta name="twitter:description" content="Invitation-only access for action takers.">
  <meta name="twitter:image" content="https://wordycow.github.io/so.t-leader-choice/img/the-unique-gate-preview.png">

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 타이틀 폰트 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; height:100%; }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      color:#f9fafb;
      background:#000;
    }

    .scene{ position:fixed; inset:0; overflow:hidden; }
    .scene-bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }

    .page-wrap{
      position:absolute; inset:0;
      display:flex; justify-content:center; align-items:center;
      padding:24px 12px;
      z-index:10;
    }

    .gate-card{
      position:relative;
      border-radius:26px;
      padding:28px 26px 22px;
      background: radial-gradient(circle at top, rgba(248,181,84,0.15), rgba(15,23,42,0.96));
      border:1px solid rgba(250,204,21,0.95);
      box-shadow: 0 0 20px rgba(250,204,21,0.75), 0 28px 70px rgba(0,0,0,0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow: visible;
      z-index:20; /* 카드가 위로 */
    }

    .gate-inner{ position:relative; z-index:1; }
    .gate-title-wrap{ text-align:center; margin-bottom:22px; }

    .gate-title{
      font-family:"Cinzel","Times New Roman",serif;
      font-weight:700;
      font-size:40px;
      letter-spacing:0.24em;
      text-transform:uppercase;
      margin-bottom:8px;

      background: linear-gradient(180deg, #fffaf0 0%, #facc6b 45%, #d97706 100%);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;

      text-shadow: 0 0 10px rgba(250,204,21,0.9), 0 4px 18px rgba(0,0,0,1);
    }

    .gate-subtitle-en{
      font-size:11px;
      opacity:0.9;
      letter-spacing:0.12em;
      text-transform:uppercase;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9), 0 0 6px rgba(0,0,0,0.6);
    }

    .form-body{ max-width:360px; margin:0 auto; }
    .gate-input-wrap{ margin-bottom:10px; }

    .gate-input{
      width:100%;
      padding:11px 14px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      background: radial-gradient(circle at top, rgba(15,23,42,0.90), rgba(3,7,18,0.96));
      color:#f9fafb;
      font-size:13px;
      outline:none;
      box-shadow: 0 4px 14px rgba(0,0,0,0.75) inset, 0 0 0 1px rgba(0,0,0,0.55);
    }
    .gate-input::placeholder{ color:#6b7280; }
    .gate-input:focus{
      border-color: rgba(248,181,84,0.95);
      box-shadow: 0 0 0 1px rgba(248,181,84,0.6), 0 6px 22px rgba(0,0,0,0.9) inset;
    }

    .btn-row{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:14px;
      margin-bottom:6px;
    }

    .btn{
      width:100%;
      min-height:42px;
      padding:10px 10px;
      border-radius:999px;
      border:1px solid transparent;
      font-size:13px;
      font-weight:700;
      letter-spacing:0.12em;
      text-transform:uppercase;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }

    .btn-primary{
      background: radial-gradient(circle at top, #f97316, #7f1d1d);
      border-color: rgba(248,181,84,0.95);
      color:#fef2f2;
      box-shadow: 0 10px 26px rgba(0,0,0,1), 0 0 0 1px rgba(0,0,0,0.5) inset;
    }
    .btn-primary:hover{ transform: translateY(-1px); }

    .btn-ghost{
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.98));
      border-color: rgba(55,65,81,1);
      color:#e5e7eb;
      box-shadow: 0 8px 22px rgba(0,0,0,0.9);
    }
    .btn-ghost:hover{ border-color: rgba(148,163,184,0.9); }

    /* 가운데 & */
    .divider-amp{
      margin: 14px 0 10px;
      text-align: center;
      font-family: "Cinzel","Times New Roman",serif;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 0.35em;
      color: transparent;
      background: linear-gradient(180deg, #fffaf0 0%, #facc6b 45%, #d97706 100%);
      -webkit-background-clip: text;
      background-clip: text;
      text-shadow:
        0 0 12px rgba(250,204,21,0.75),
        0 6px 18px rgba(0,0,0,1);
      opacity: 0.95;
      user-select: none;
    }

    /* 아이콘 때문에 버튼 커지던 문제 해결 */
    .btn-with-icon{ gap:10px; justify-content:center; }
    .btn-with-icon svg{
      width:18px !important; height:18px !important;
      max-width:18px !important; max-height:18px !important;
      flex: 0 0 18px !important;
      display:block !important;
    }
    .btn-with-icon span{ line-height:1; }

    /* UNIQUE 마켓 버튼(골드) */
    .btn-market{
      background: radial-gradient(circle at top, rgba(250,204,21,0.95), rgba(202,138,4,0.55));
      color:#111827;
      border-color: rgba(250,204,21,0.95);
      box-shadow: 0 12px 28px rgba(0,0,0,0.95);
      letter-spacing: 0.16em;
      font-weight: 900;
    }
    .btn-market:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(0,0,0,1);
    }

    .status{
      min-height:18px;
      font-size:11px;
      text-align:center;
      margin-top:2px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9);
    }
    .status-error{ color:#fecaca; }

    /* 마녀 & 박쥐 */
    .spirit{ position:absolute; pointer-events:none; z-index:5; }
    .spirit img{ display:block; width:100%; height:auto; }

    .spirit-witch{
      top:30%;
      right:22%;
      width:3%;
      animation: witchFloat 5s ease-in-out infinite alternate;
      z-index:30;
    }
    @keyframes witchFloat{
      from { transform: translateY(5px) translateX(0); }
      to   { transform: translateY(-20px) translateX(6px); }
    }

    .spirit-bat{
      top:-20%;
      right:0%;
      width:43%;
      animation: batFloat 2s ease-in-out infinite alternate;
      z-index:1; /* 박쥐는 카드 뒤 */
    }
    @keyframes batFloat{
      from { transform: translateY(8px); }
      to   { transform: translateY(22px); }
    }

    @media (max-width: 768px){
      .gate-card{ padding:24px 20px 18px; border-radius:22px; }
      .gate-title{ font-size:32px; letter-spacing:0.22em; }
      .form-body{ max-width:100%; }
      .spirit-witch{ top:26%; right:20%; width:10%; }
      .spirit-bat{ top:18%; right:10%; width:30%; }
    }
  </style>
</head>

<body>
  <div class="scene">
    <img src="img/bg-unique-gate-clean.jpg" class="scene-bg" alt="The Unique Gate background">
  </div>

  <div class="page-wrap">
    <main class="gate-card">
      <div class="gate-inner">
        <div class="gate-title-wrap">
          <div class="gate-title">THE UNIQUE</div>
          <div class="gate-subtitle-en">Invitation-only access for action takers</div>
        </div>

        <form id="gate-form" class="form-body">
          <div class="gate-input-wrap">
            <input id="login-id" class="gate-input" type="text" autocomplete="off" placeholder="아이디(구글시트)" />
          </div>

          <div class="btn-row">
            <button type="submit" class="btn btn-primary">로그인</button>
            <a href="the-unique-signup.html" class="btn btn-ghost">회원가입</a>
          </div>

          <div id="status" class="status"></div>

          <div class="divider-amp">&amp;</div>

          <div class="btn-row" style="margin-top:10px;">
            <!-- ✅ 구글로 마켓 (G만) -->
            <button type="button" id="btnMarket" class="btn btn-market btn-with-icon">
              <svg viewBox="0 0 533.5 544.3" aria-hidden="true">
                <path fill="#4285F4" d="M533.5 278.4c0-18.5-1.5-37-4.7-55.2H272.1v104.6h146.9c-6.3 33.8-25 62.5-53.3 81.7v67h86.2c50.5-46.5 81.6-115.2 81.6-198.1z"/>
                <path fill="#34A853" d="M272.1 544.3c72.6 0 133.6-24.1 178.2-65.6l-86.2-67c-24 16.1-54.7 25.6-92 25.6-70.7 0-130.6-47.7-152.1-111.7H30.9v70.3c44.4 88.3 135.7 149.1 241.2 149.1z"/>
                <path fill="#FBBC05" d="M120 325.6c-10.8-32.3-10.8-67.3 0-99.6V155.7H30.9c-40.6 80.9-40.6 177.9 0 258.8L120 325.6z"/>
                <path fill="#EA4335" d="M272.1 107.7c39.5-.6 77.6 13.9 106.7 40.8l79.6-79.6C410.3 24.1 344.7-1.5 272.1 0 166.6 0 75.3 60.8 30.9 149.1l89.1 70.3c21.4-64 81.4-111.7 152.1-111.7z"/>
              </svg>
              <span>UNIQUE 마켓</span>
            </button>

            <button type="button" id="btnLogout" class="btn btn-ghost" style="display:none;">구글 로그아웃</button>
          </div>

          <div id="oauth-status" class="status"></div>
        </form>
      </div>
    </main>

    <div class="spirit spirit-witch"><img src="img/witch-float.png" alt=""></div>
    <div class="spirit spirit-bat"><img src="img/bat-float.png" alt=""></div>
  </div>

  <!-- ====== 시트는 아이디 로그인 눌렀을 때만 로드(속도 개선) ====== -->
  <script>
    let allowedIds = null;
    let memberInfoById = {};
    let sheetError = false;
    let _sheetPromise = null;

    function handleSheetResponse(resp) {
      try {
        const rows = resp.table.rows || [];
        const ids = [];

        rows.forEach((row) => {
          const cells = row.c || [];
          const tsCell   = cells[5] || cells[0];
          const idCell   = cells[1];
          const nameCell = cells[2];
          const teamCell = cells[4];

          if (!idCell || idCell.v == null) return;

          const rawId = String(idCell.v).trim();
          if (!rawId || rawId === "아이디") return;

          const idLower = rawId.toLowerCase();
          ids.push(idLower);

          const name = nameCell && nameCell.v ? String(nameCell.v).trim() : "";
          const team = teamCell && teamCell.v ? String(teamCell.v).trim() : "";
          const joinedAt = tsCell && tsCell.v ? String(tsCell.v).trim() : "";

          memberInfoById[idLower] = { id: rawId, name, team, joinedAt };
        });

        allowedIds = new Set(ids);
      } catch (e) {
        console.error("시트 파싱 오류:", e);
        sheetError = true;
      }
    }

    function loadSheetOnce() {
      if (_sheetPromise) return _sheetPromise;

      _sheetPromise = new Promise((resolve) => {
        const SSID = "1SUXCiLg7sbZ_2OxanCEgVwgk3dJhZLhyX0-lltTxBnM";
        const GID  = "160409301";
        const url  = `https://docs.google.com/spreadsheets/d/${SSID}/gviz/tq?gid=${GID}&tqx=responseHandler:handleSheetResponse&cb=${Date.now()}`;

        const s = document.createElement("script");
        s.src = url;
        s.onload = () => resolve();
        s.onerror = () => { sheetError = true; resolve(); };
        document.head.appendChild(s);

        setTimeout(() => resolve(), 1800);
      });

      return _sheetPromise;
    }
  </script>

  <!-- ====== 아이디(구글시트) 로그인 ====== -->
  <script>
    const form = document.getElementById("gate-form");
    const idInput = document.getElementById("login-id");
    const statusEl = document.getElementById("status");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const id = (idInput.value || "").trim();
      statusEl.textContent = "";
      statusEl.className = "status";

      if (!id) {
        statusEl.textContent = "아이디를 입력해 주세요.";
        statusEl.classList.add("status-error");
        return;
      }

      if (!allowedIds && !sheetError) {
        statusEl.textContent = "회원 정보 불러오는 중...";
        await loadSheetOnce();
      }

      if (sheetError) {
        statusEl.textContent = "시트 접근 오류. 시트 공유를 '링크 공개(보기)'로 바꿔야 합니다.";
        statusEl.classList.add("status-error");
        return;
      }

      if (!allowedIds) {
        statusEl.textContent = "회원 정보가 아직 준비되지 않았습니다. 새로고침 후 다시 시도해 주세요.";
        statusEl.classList.add("status-error");
        return;
      }

      const normalized = id.toLowerCase();
      if (allowedIds.has(normalized)) {
        const info = memberInfoById[normalized] || {};
        localStorage.setItem("uniqueCurrentUser", JSON.stringify({
          id: normalized,
          name: info.name || "",
          team: info.team || "",
          joinedAt: info.joinedAt || "",
          via: "sheet-id"
        }));
        window.location.href = "the-unique-main.html";
      } else {
        statusEl.textContent = "등록되지 않은 아이디입니다.";
        statusEl.classList.add("status-error");
      }
    });
  </script>

  <!-- ====== 구글 로그인 → 마켓(team-market.html / market.html) ====== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://lrpscubricemcgfssjgg.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_8mMA4oEsuB9j0rc6KsLmtQ_UkJo0Zaq";

    const GATE_URL = "https://wordycow.github.io/so.t-leader-choice/the-unique-gate.html";
    const MARKET_CANDIDATES = ["team-market.html", "market.html"]; // 둘 중 존재하는 걸로 이동

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { flowType: "implicit", detectSessionInUrl: true, persistSession: true, autoRefreshToken: true }
    });

    const oauthStatusEl = document.getElementById("oauth-status");
    const btnLogout = document.getElementById("btnLogout");
    const btnMarket = document.getElementById("btnMarket");

    function say(msg, isErr=false){
      if (!oauthStatusEl) return;
      oauthStatusEl.textContent = msg || "";
      oauthStatusEl.className = "status" + (isErr ? " status-error" : "");
    }

    let _marketResolved = null;
    async function resolveMarketUrl(){
      if (_marketResolved) return _marketResolved;

      for (const p of MARKET_CANDIDATES) {
        try{
          const r = await fetch(p + "?v=" + Date.now(), { method: "GET", cache: "no-store" });
          if (r.ok) { _marketResolved = p; return p; }
        } catch {}
      }
      _marketResolved = "team-market.html";
      return _marketResolved;
    }

    async function goMarket(){
      const url = await resolveMarketUrl();
      location.href = url;
    }

    async function openGoogleOrGoMarket(){
      const { data } = await sb.auth.getSession();
      if (data?.session) {
        await goMarket();
        return;
      }

      say("구글 로그인 여는 중...");
      const { error } = await sb.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: GATE_URL }
      });
      if (error) say("구글 로그인 실패: " + error.message, true);
    }

    btnMarket?.addEventListener("click", () => openGoogleOrGoMarket());

    btnLogout?.addEventListener("click", async () => {
      await sb.auth.signOut();
      say("로그아웃 완료");
      btnLogout.style.display = "none";
    });

    // 로그인 콜백으로 돌아오면 즉시 마켓 이동
    sb.auth.onAuthStateChange(async (evt, session) => {
      if (evt === "SIGNED_IN" && session) {
        btnLogout.style.display = "inline-flex";
        await goMarket();
      }
    });

    // 이미 로그인 상태면 로그아웃 버튼만 보여주기
    (async () => {
      const { data } = await sb.auth.getSession();
      if (data?.session) btnLogout.style.display = "inline-flex";
    })();
  </script>
</body>
</html>
