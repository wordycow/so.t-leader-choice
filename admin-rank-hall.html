<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>The Unique – Rank Hall 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; height:100%; }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI","Pretendard", sans-serif;
      background: radial-gradient(circle at top, #020617, #020617 55%);
      color:#e5e7eb;
    }
    a{ color:inherit; }

    .page-wrap{ max-width:1200px; margin:32px auto 40px; padding:0 16px 24px; }
    .header{ margin-bottom:14px; }
    .title{
      font-size:24px; font-weight:700; letter-spacing:0.18em; text-transform:uppercase;
      color:#facc15; text-shadow:0 0 10px rgba(250,204,21,0.7);
    }
    .subtitle{ font-size:12px; color:#9ca3af; margin-top:4px; line-height:1.6; }

    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; margin:14px 0; }
    .toolbar-btn{
      padding:7px 12px; border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background: rgba(15,23,42,0.98);
      color:#e5e7eb; font-size:11px; font-weight:700;
      letter-spacing:0.08em; text-transform:uppercase;
      cursor:pointer;
      transition: background .15s ease, transform .08s ease, border-color .15s ease;
    }
    .toolbar-btn.primary{
      border-color: rgba(248,181,84,0.9);
      background: radial-gradient(circle at top, #f97316, #7f1d1d);
      color:#fef2f2;
    }
    .toolbar-btn:hover{
      transform: translateY(-1px);
      background: rgba(30,64,175,0.9);
      border-color: rgba(191,219,254,0.9);
    }
    .toolbar input{
      height:30px; padding:0 12px; border-radius:999px;
      border:1px solid rgba(51,65,85,0.9);
      background: rgba(15,23,42,0.98);
      color:#e5e7eb; font-size:12px; outline:none;
      min-width: 220px;
    }
    .toolbar input:focus{
      border-color: rgba(248,181,84,0.9);
      box-shadow: 0 0 0 1px rgba(248,181,84,0.6);
    }

    .layout{
      display:grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.1fr);
      gap:14px;
      align-items:flex-start;
    }
    .panel{
      border-radius:20px;
      padding:14px 14px 16px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(15,23,42,0.99));
      box-shadow: 0 0 0 1px rgba(30,64,118,0.8), 0 18px 45px rgba(0,0,0,0.95);
    }
    .panel-title{ font-size:13px; font-weight:700; margin-bottom:8px; }
    .panel-sub{ font-size:11px; color:#9ca3af; margin-bottom:10px; line-height:1.6; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .card{
      border-radius:18px;
      padding:12px;
      background: radial-gradient(circle at top, #020617, #020617);
      border:1px solid rgba(51,65,85,0.9);
      display:grid;
      grid-template-columns: minmax(0, 1fr);
      gap:10px;
    }

    .row{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    .row.full{ grid-template-columns: 1fr; }

    .label{ font-size:11px; color:#9ca3af; margin-bottom:3px; }
    .input, .textarea{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(51,65,85,0.9);
      background: rgba(15,23,42,0.98);
      color:#e5e7eb;
      font-size:12px;
      padding:6px 8px;
      outline:none;
    }
    .textarea{ min-height:56px; resize:vertical; }
    .input:focus, .textarea:focus{
      border-color: rgba(248,181,84,0.9);
      box-shadow: 0 0 0 1px rgba(248,181,84,0.6);
    }

    .meta{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; font-size:11px; color:#9ca3af;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.65);
      color:#cbd5e1;
    }
    .pill input{ width:12px; height:12px; }

    .delete-btn{
      align-self:flex-start;
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(248,113,113,0.9);
      background: rgba(127,29,29,0.9);
      color:#fee2e2;
      cursor:pointer;
      font-size:11px; font-weight:700;
    }
    .delete-btn:hover{ transform: translateY(-1px); }

    .json-textarea{
      width:100%;
      min-height:360px;
      border-radius:12px;
      border:1px solid rgba(51,65,85,0.9);
      background:#020617;
      color:#e5e7eb;
      font-size:11px;
      padding:8px 9px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      resize: vertical;
      line-height:1.55;
    }
    .json-textarea:focus{
      outline:none;
      border-color: rgba(248,181,84,0.9);
      box-shadow: 0 0 0 1px rgba(248,181,84,0.6);
    }

    .footer-note{ margin-top:10px; font-size:11px; color:#6b7280; text-align:right; opacity:.85; }

    @media (max-width: 960px){
      .layout{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="page-wrap">
    <header class="header">
      <div class="title">THE UNIQUE – RANK HALL ADMIN</div>
      <div class="subtitle">
        이 화면에서 <code>rank-hall.json</code> (또는 <code>hall.json</code>)용 데이터를 편집합니다.<br>
        ✅ <strong>id(시트 아이디)</strong>를 포함해서 저장하면, “이름 매칭” 문제 없이 100% 정확하게 직급을 찾습니다.
      </div>
    </header>

    <div class="toolbar">
      <button id="add-btn" class="toolbar-btn primary">+ 멤버 추가</button>
      <button id="export-btn" class="toolbar-btn">JSON 내보내기</button>
      <button id="import-btn" class="toolbar-btn">JSON 불러오기</button>
      <button id="copy-btn" class="toolbar-btn">JSON 복사</button>

      <a class="toolbar-btn" target="_blank" rel="noopener noreferrer"
         href="https://github.com/wordycow/so.t-leader-choice/blob/main/rank-hall.json">
        rank-hall.json 열기
      </a>

      <input id="search" placeholder="검색 (id / 이름 / 직급)" />
    </div>

    <div class="layout">
      <section class="panel">
        <div class="panel-title">직급자 편집</div>
        <div class="panel-sub">
          - <strong>id</strong>: 게이트에서 쓰는 아이디(시트 아이디)와 동일하게(소문자 권장)<br>
          - <strong>rank</strong>: 예) STAR3 / PRO2 / STAFF 등<br>
          - <strong>note</strong>: 직급자 노트(한 줄 또는 여러 줄)
        </div>

        <div id="list" class="list"></div>
      </section>

      <section class="panel">
        <div class="panel-title">rank-hall.json 미리보기 / 편집</div>
        <div class="panel-sub">
          ▸ [JSON 내보내기] 누르면 아래에 JSON이 만들어짐 → 그대로 <code>rank-hall.json</code>에 붙여넣기<br>
          ▸ Import는 아래 textarea에 JSON 붙여넣고 [JSON 불러오기] 누르면 됨
        </div>
        <textarea id="json" class="json-textarea" spellcheck="false"></textarea>
      </section>
    </div>

    <div class="footer-note">THE UNIQUE – Rank Hall Admin · so.t-leader-choice</div>
  </div>

  <script>
    (function(){
      let members = [];

      const listEl = document.getElementById("list");
      const jsonEl = document.getElementById("json");
      const searchEl = document.getElementById("search");

      const addBtn = document.getElementById("add-btn");
      const exportBtn = document.getElementById("export-btn");
      const importBtn = document.getElementById("import-btn");
      const copyBtn = document.getElementById("copy-btn");

      function nowIso(){ return new Date().toISOString(); }

      function normId(v){
        return (v || "").toString().trim().toLowerCase();
      }

      function createDefault(){
        return {
          id: "",
          name: "",
          rank: "",
          note: "",
          visible: true,
          order: members.length + 1,
          updatedAt: nowIso()
        };
      }

      function exportData(){
        // ✅ 반드시 포함해야 하는 필드만 정리해서 내보냄
        const out = members
          .slice()
          .sort((a,b) => (a.order||0) - (b.order||0))
          .map(m => ({
            id: normId(m.id),
            name: (m.name || "").toString().trim(),
            rank: (m.rank || "").toString().trim(),
            note: (m.note || "").toString(),
            visible: m.visible !== false,
            order: Number.isFinite(+m.order) ? +m.order : 0,
            updatedAt: (m.updatedAt || nowIso())
          }));

        return { members: out };
      }

      function updateJsonTextarea(){
        jsonEl.value = JSON.stringify(exportData(), null, 2);
      }

      function render(){
        const q = (searchEl.value || "").toLowerCase().trim();
        listEl.innerHTML = "";

        members
          .slice()
          .sort((a,b) => (a.order||0) - (b.order||0))
          .forEach((m, idx) => {
            const hay = `${m.id} ${m.name} ${m.rank}`.toLowerCase();
            if (q && !hay.includes(q)) return;

            const card = document.createElement("div");
            card.className = "card";

            const meta = document.createElement("div");
            meta.className = "meta";

            const left = document.createElement("div");
            left.className = "pill";
            const vis = document.createElement("input");
            vis.type = "checkbox";
            vis.checked = m.visible !== false;
            vis.addEventListener("change", () => {
              m.visible = vis.checked;
              m.updatedAt = nowIso();
              updateJsonTextarea();
            });
            left.appendChild(vis);
            left.appendChild(document.createTextNode("노출"));

            const right = document.createElement("div");
            right.textContent = `updated: ${m.updatedAt ? m.updatedAt.split("T")[0] : "-"}`;

            meta.appendChild(left);
            meta.appendChild(right);

            const row1 = document.createElement("div");
            row1.className = "row";

            // id
            row1.appendChild(field("아이디(id)", m.id, (v) => {
              m.id = normId(v);
              m.updatedAt = nowIso();
            }, { placeholder:"예: yusong (소문자 권장)" }));

            // name
            row1.appendChild(field("이름(name)", m.name, (v) => {
              m.name = v;
              m.updatedAt = nowIso();
            }, { placeholder:"예: 이유송" }));

            const row2 = document.createElement("div");
            row2.className = "row";

            // rank
            row2.appendChild(field("직급(rank)", m.rank, (v) => {
              m.rank = v;
              m.updatedAt = nowIso();
            }, { placeholder:"예: PRO3 / STAR2 / STAFF" }));

            // order
            row2.appendChild(field("정렬(order)", m.order, (v) => {
              const n = parseInt(v, 10);
              m.order = isNaN(n) ? 0 : n;
              m.updatedAt = nowIso();
            }, { type:"number", placeholder:"예: 1" }));

            const row3 = document.createElement("div");
            row3.className = "row full";

            // note
            row3.appendChild(field("직급자 노트(note)", m.note, (v) => {
              m.note = v;
              m.updatedAt = nowIso();
            }, { textarea:true, placeholder:"메모/노트 (여러 줄 가능)" }));

            const del = document.createElement("button");
            del.type = "button";
            del.className = "delete-btn";
            del.textContent = "삭제";
            del.addEventListener("click", () => {
              if (!confirm("이 멤버를 삭제할까요?")) return;
              members.splice(members.indexOf(m), 1);
              render();
              updateJsonTextarea();
            });

            card.appendChild(meta);
            card.appendChild(row1);
            card.appendChild(row2);
            card.appendChild(row3);
            card.appendChild(del);

            listEl.appendChild(card);
          });
      }

      function field(labelText, value, onChange, opt={}){
        const wrap = document.createElement("div");

        const lab = document.createElement("div");
        lab.className = "label";
        lab.textContent = labelText;
        wrap.appendChild(lab);

        let el;
        if (opt.textarea){
          el = document.createElement("textarea");
          el.className = "textarea";
          el.placeholder = opt.placeholder || "";
          el.value = value ?? "";
          el.addEventListener("input", () => { onChange(el.value); updateJsonTextarea(); });
        } else {
          el = document.createElement("input");
          el.className = "input";
          el.type = opt.type || "text";
          el.placeholder = opt.placeholder || "";
          el.value = value ?? "";
          el.addEventListener("input", () => { onChange(el.value); updateJsonTextarea(); });
        }

        wrap.appendChild(el);
        return wrap;
      }

      // Buttons
      addBtn.addEventListener("click", () => {
        members.push(createDefault());
        render();
        updateJsonTextarea();
      });

      exportBtn.addEventListener("click", () => {
        updateJsonTextarea();
        alert("현재 직급자 목록이 JSON으로 출력되었습니다. 그대로 rank-hall.json에 붙여 넣으면 됩니다.");
      });

      importBtn.addEventListener("click", () => {
        const text = (jsonEl.value || "").trim();
        if (!text) { alert("불러올 JSON이 없습니다. 먼저 JSON을 붙여 넣어 주세요."); return; }
        try {
          const parsed = JSON.parse(text);
          const arr =
            parsed.members || parsed.items || (Array.isArray(parsed) ? parsed : []);

          if (!Array.isArray(arr)) throw new Error("members/items 배열이 없습니다.");

          members = arr.map((m, i) => ({
            id: normId(m.id),
            name: (m.name || "").toString(),
            rank: (m.rank || m.level || m.title || "").toString(),
            note: (m.note || m.memo || "").toString(),
            visible: m.visible !== false,
            order: Number.isFinite(+m.order) ? +m.order : (i+1),
            updatedAt: (m.updatedAt || nowIso())
          }));

          render();
          updateJsonTextarea();
          alert("JSON에서 직급자 목록을 불러왔습니다.");
        } catch(e){
          console.error(e);
          alert("JSON 파싱 실패. 형식을 확인해 주세요.");
        }
      });

      copyBtn.addEventListener("click", () => {
        if (!jsonEl.value.trim()) updateJsonTextarea();
        jsonEl.select();
        jsonEl.setSelectionRange(0, jsonEl.value.length);
        try {
          const ok = document.execCommand("copy");
          alert(ok ? "JSON이 클립보드에 복사되었습니다." : "복사 실패. 직접 드래그해서 복사해 주세요.");
        } catch {
          alert("복사 실패. 직접 드래그해서 복사해 주세요.");
        }
      });

      searchEl.addEventListener("input", () => render());

      // Initial load: rank-hall.json
      fetch("rank-hall.json?v=" + Date.now(), { cache:"no-store" })
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(data => {
          const arr = data.members || data.items || (Array.isArray(data) ? data : []);
          members = Array.isArray(arr) ? arr.map((m,i) => ({
            id: normId(m.id),
            name: (m.name || "").toString(),
            rank: (m.rank || m.level || m.title || "").toString(),
            note: (m.note || m.memo || "").toString(),
            visible: m.visible !== false,
            order: Number.isFinite(+m.order) ? +m.order : (i+1),
            updatedAt: (m.updatedAt || nowIso())
          })) : [];
          render();
          updateJsonTextarea();
        })
        .catch(err => {
          console.warn("rank-hall.json 로드 실패(없어도 OK):", err);
          members = [];
          render();
          updateJsonTextarea();
        });
    })();
  </script>
</body>
</html>
