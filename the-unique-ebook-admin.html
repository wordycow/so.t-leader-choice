<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>The Unique – eBook 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px 16px 40px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 22px;
    }
    .tip {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    /* 상단 Member Hall로 돌아가기 */
    .top-bar {
      max-width: 1300px;
      margin: 0 auto 12px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }
    .back-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: linear-gradient(135deg, #1f2937, #020617);
      color: #e5e7eb;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .back-btn:hover {
      border-color: rgba(248,250,252,0.9);
      background: linear-gradient(135deg, #111827, #020617);
    }

    /* 왼쪽 편집 / 오른쪽 미리보기 */
    .admin-layout {
      max-width: 1300px;
      margin: 0 auto 24px;
      display: grid;
      grid-template-columns: minmax(0, 2.4fr) minmax(0, 1.6fr);
      gap: 20px;
      align-items: flex-start;
    }
    .edit-wrap {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .book-list { margin: 0; }

    .book-row {
      display: flex;
      gap: 16px;
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 14px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(148,163,184,0.5);
    }
    .thumb {
      flex: 0 0 140px;
    }
    .thumb-frame {
      width: 140px;
      height: 140px;
      border-radius: 16px;
      overflow: hidden;
      background: #111827;
      border: 1px solid #4b5563;
    }
    .thumb-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .thumb-upload {
      display: block;
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
    }

    .fields {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px 16px;
      align-content: flex-start;
    }
    .field {
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }
    .field label {
      margin-bottom: 4px;
      color: #9ca3af;
    }
    .field input[type="text"],
    .field input[type="number"],
    .field select {
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
    }
    .field input[type="checkbox"] {
      transform: scale(1.1);
    }
    .field input[type="range"] {
      width: 100%;
    }
    .field span.value {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .row-actions {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: flex-end;
      gap: 8px;
      flex: 0 0 80px;
    }
    .btn-small {
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid rgba(239,68,68,0.7);
      background: transparent;
      color: #fecaca;
      font-size: 11px;
      cursor: pointer;
    }
    .btn-small:hover {
      background: rgba(239,68,68,0.2);
    }

    /* 오른쪽 미리보기 패널 - sticky */
    .preview-panel {
      background: rgba(15,23,42,0.96);
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.5);
      padding: 14px 16px 16px;
      position: sticky;
      top: 16px;
      max-height: calc(100vh - 48px);
      overflow-y: auto;
    }
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .preview-title {
      font-size: 14px;
      font-weight: 600;
    }
    .preview-rank-select {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    .preview-rank-select select {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
    }
    .preview-desc {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .preview-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .preview-empty {
      font-size: 12px;
      color: #9ca3af;
      padding: 8px 2px;
    }
    .preview-card {
      display: flex;
      gap: 10px;
      padding: 10px;
      border-radius: 12px;
      background: linear-gradient(135deg, #111827, #020617);
      border: 1px solid rgba(30,64,118,0.9);
    }
    .preview-thumb {
      width: 72px;
      height: 72px;
      border-radius: 10px;
      overflow: hidden;
      background: #020617;
      flex-shrink: 0;
    }
    .preview-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .preview-body {
      flex: 1;
      min-width: 0;
    }
    .preview-body-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .preview-body-sub {
      font-size: 11px;
      color: #cbd5f5;
      margin-bottom: 4px;
    }
    .preview-meta {
      font-size: 10px;
      color: #9ca3af;
    }

    .export-box {
      max-width: 1300px;
      margin: 0 auto;
    }
    .export-btn,
    .add-btn,
    .secondary-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 8px;
      margin-right: 8px;
    }
    .add-btn {
      background: #22c55e;
      color: #022c22;
    }
    .export-btn {
      background: #f97316;
      color: #111827;
    }
    .secondary-btn {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 13px;
      padding-inline: 12px;
    }
    .secondary-btn:hover {
      border-color: rgba(248,250,252,0.9);
      background: rgba(15,23,42,0.8);
    }

    .secondary-select {
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: #020617;
      color: #e5e7eb;
      margin-bottom: 8px;
      margin-right: 8px;
    }

    textarea {
      width: 100%;
      min-height: 260px;
      border-radius: 12px;
      padding: 10px;
      font-size: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      resize: vertical;
    }
    .export-help {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    @media (max-width: 900px) {
      .admin-layout {
        grid-template-columns: minmax(0, 1fr);
      }
      .preview-panel {
        position: static;
        max-height: none;
      }
    }
    @media (max-width: 700px) {
      .book-row {
        flex-direction: column;
      }
      .row-actions {
        flex-direction: row;
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button class="back-btn" onclick="window.location.href='the-unique-main.html'">
      Member Hall로 돌아가기
    </button>
  </div>

  <h1>The Unique eBook 관리자</h1>
  <div class="tip">
    ▸ 각 책의 <b>제목 / 부제 / 커버 / mp4 / mp3 / 노출 / 직급 범위 / 순서 / 이미지 위치</b>를 조정한 뒤,<br>
    ▸ <b>JSON 내보내기</b> 버튼을 눌러 나온 내용을 <code>ebook-config.json</code>에 복사해서 저장하면 됩니다.<br>
    ▸ <b>선택 eBook HTML 생성</b> 버튼으로 “행동 매뉴얼 eBook” 기본 틀에 맞춘 <b>새 HTML 파일</b>도 자동 생성할 수 있습니다.
  </div>

  <div class="admin-layout">
    <div class="edit-wrap">
      <div id="bookList" class="book-list"></div>
    </div>

    <aside class="preview-panel">
      <div class="preview-header">
        <div class="preview-title">Member Hall eBook 미리보기</div>
        <div class="preview-rank-select">
          <span>직급:</span>
          <select id="previewRank">
            <option value="">모든 직급</option>
            <option value="Star1">Star1</option>
            <option value="Star2">Star2</option>
            <option value="Star3">Star3</option>
            <option value="Pro1">Pro1</option>
            <option value="Pro2">Pro2</option>
            <option value="Pro3">Pro3</option>
            <option value="Pro4">Pro4</option>
            <option value="Pro5">Pro5</option>
            <option value="Pro6">Pro6</option>
            <option value="Pro7">Pro7</option>
            <option value="Pro8">Pro8</option>
            <option value="Pro9">Pro9</option>
            <option value="Pro10">Pro10</option>
          </select>
        </div>
      </div>
      <div class="preview-desc">
        • 실제 Member Hall의 eBook 카드 레이아웃을 미리 확인할 수 있습니다.<br>
        • 직급을 바꾸면 <code>최소/최대 직급</code> 설정에 맞는 항목만 보입니다.
      </div>
      <div id="previewList" class="preview-list"></div>
    </aside>
  </div>

  <div class="export-box">
    <button id="addBtn" class="add-btn">+ 책 추가</button>
    <button id="exportBtn" class="export-btn">JSON 내보내기</button>
    <button id="copyBtn" class="secondary-btn">JSON 복사</button>
    <button id="openGithubBtn" class="secondary-btn">ebook-config.json 열기</button>

    <!-- 새 HTML 생성용: eBook 선택 + 버튼 -->
    <select id="htmlBookSelect" class="secondary-select">
      <option value="">HTML 만들 eBook 선택…</option>
    </select>
    <button id="htmlBtn" class="secondary-btn">선택 eBook HTML 생성</button>

    <div class="export-help">
      • 아래 영역에는 <b>JSON</b> 또는 <b>선택한 eBook용 HTML 템플릿</b>이 출력됩니다. 상황에 맞게 복사해서 사용하세요.<br>
      • HTML 템플릿은 <code>ebook-무슨무슨.html</code> 같은 이름으로 새 파일에 붙여 넣으면 됩니다.
    </div>
    <textarea id="jsonOutput" readonly placeholder="여기에 JSON 또는 HTML이 생성됩니다."></textarea>
  </div>

  <script>
    const RANKS = [
      "", "Star1", "Star2", "Star3",
      "Pro1", "Pro2", "Pro3", "Pro4",
      "Pro5", "Pro6", "Pro7", "Pro8", "Pro9", "Pro10"
    ];

    // 기본 샘플 (ebook-config.json이 아직 없을 때 사용)
    let items = [
      {
        id: "unique-basic",
        title: "협력을 배우고 협력을 만들어낸다.",
        subtitle: "THE UNIQUE 기본 매뉴얼",
        description: "누구나 언제라도 다시 볼 수 있는 THE UNIQUE 기본 매뉴얼입니다.",
        cover: "img/ebook-the-unique-system-book.jpg",
        video: "img/the-unique-system.mp4",
        audio: "audio/the-unique-system.mp3",
        link: "ebook.html",
        visible: true,
        rankMin: "Star1",
        rankMax: "Pro10",
        order: 1,
        posY: 50
      },
      {
        id: "unique-sot",
        title: "현대 사회에 맞는 여행도구 so.t",
        subtitle: "so.t 안에서 서로를 챙겨주며 함께 여행을 그린다.",
        description: "",
        cover: "img/ebook-network-marketing-cover.jpg",
        video: "img/the-unique-sot.mp4",
        audio: "audio/the-unique-sot.mp3",
        link: "ebook1.html",
        visible: true,
        rankMin: "Pro1",
        rankMax: "Pro10",
        order: 2,
        posY: 50
      }
    ];

    // ebook-config.json 이 있으면 그걸로 덮어쓰기
    fetch("ebook-config.json")
      .then(function(res) {
        if (!res.ok) throw new Error("status " + res.status);
        return res.json();
      })
      .then(function(data) {
        if (data && Array.isArray(data.items) && data.items.length > 0) {
          items = data.items;
        }
        normalizeItems();
        renderList();
        updatePreview();
        refreshHtmlSelect();
      })
      .catch(function(err) {
        console.warn("ebook-config.json 불러오기 실패, 기본값 사용:", err);
        normalizeItems();
        renderList();
        updatePreview();
        refreshHtmlSelect();
      });

    function normalizeItems() {
      items.forEach(function(item, index) {
        if (typeof item.order !== "number") item.order = index + 1;
        if (typeof item.posY !== "number") item.posY = 50;
        if (typeof item.visible !== "boolean") item.visible = true;
      });
    }

    function renderList() {
      const listEl = document.getElementById("bookList");
      listEl.innerHTML = "";

      items.forEach(function(item, index) {
        const row = document.createElement("div");
        row.className = "book-row";

        // 썸네일
        const thumb = document.createElement("div");
        thumb.className = "thumb";
        const frame = document.createElement("div");
        frame.className = "thumb-frame";
        const img = document.createElement("img");
        img.src = item.cover || "";
        img.alt = item.title || "";
        const posY = (typeof item.posY === "number") ? item.posY : 50;
        img.style.objectPosition = "50% " + posY + "%";
        frame.appendChild(img);
        thumb.appendChild(frame);

        // 파일 첨부 (로컬 미리보기 + 경로 자동 입력)
        const uploadLabel = document.createElement("label");
        uploadLabel.className = "thumb-upload";
        uploadLabel.textContent = "커버 이미지 파일: ";
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        uploadLabel.appendChild(fileInput);
        thumb.appendChild(uploadLabel);

        // 필드들
        const fields = document.createElement("div");
        fields.className = "fields";

        // ID
        fields.appendChild(makeTextField("ID (영문 키)", item.id || "", function(v) {
          item.id = v.trim();
          refreshHtmlSelect();
          updatePreview();
        }));

        // 제목
        fields.appendChild(makeTextField("제목", item.title || "", function(v) {
          item.title = v;
          updatePreview();
        }));

        // 부제
        fields.appendChild(makeTextField("부제", item.subtitle || "", function(v) {
          item.subtitle = v;
          updatePreview();
        }));

        // 커버 이미지 경로 (텍스트 입력)
        const coverField = document.createElement("div");
        coverField.className = "field";
        const coverLabel = document.createElement("label");
        coverLabel.textContent = "커버 이미지 경로";
        const coverInput = document.createElement("input");
        coverInput.type = "text";
        coverInput.value = item.cover || "";
        coverInput.addEventListener("input", function() {
          item.cover = this.value;
          img.src = this.value;
          updatePreview();
        });
        coverField.appendChild(coverLabel);
        coverField.appendChild(coverInput);
        fields.appendChild(coverField);

        // 파일 선택 시: 썸네일 미리보기 + 경로 자동 입력
        fileInput.addEventListener("change", function() {
          const file = this.files && this.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function(ev) {
            img.src = ev.target.result;
          };
          reader.readAsDataURL(file);

          const safeName = file.name.replace(/\s+/g, "-");
          const suggestedPath = "img/" + safeName;
          item.cover = suggestedPath;
          coverInput.value = suggestedPath;
          updatePreview();
        });

        // 영상(mp4) 경로
        fields.appendChild(makeTextField("영상 파일(mp4) 경로", item.video || "", function(v) {
          item.video = v;
        }));

        // 음성(mp3) 경로
        fields.appendChild(makeTextField("음성 파일(mp3) 경로", item.audio || "", function(v) {
          item.audio = v;
        }));

        // 링크
        fields.appendChild(makeTextField("클릭 시 이동할 링크", item.link || "", function(v) {
          item.link = v;
        }));

        // 노출 여부
        const visibleField = document.createElement("div");
        visibleField.className = "field";
        const vLabel = document.createElement("label");
        vLabel.textContent = "노출";
        const vInput = document.createElement("input");
        vInput.type = "checkbox";
        vInput.checked = item.visible !== false;
        vInput.addEventListener("change", function() {
          item.visible = this.checked;
          updatePreview();
        });
        visibleField.appendChild(vLabel);
        visibleField.appendChild(vInput);
        fields.appendChild(visibleField);

        // 최소 직급
        fields.appendChild(makeRankField("최소 직급(rankMin)", item.rankMin, function(v) {
          item.rankMin = v || null;
          updatePreview();
        }));

        // 최대 직급
        fields.appendChild(makeRankField("최대 직급(rankMax)", item.rankMax, function(v) {
          item.rankMax = v || null;
          updatePreview();
        }));

        // 순서(order)
        const orderField = document.createElement("div");
        orderField.className = "field";
        const oLabel = document.createElement("label");
        oLabel.textContent = "순서(order)";
        const oInput = document.createElement("input");
        oInput.type = "number";
        oInput.value = item.order || (index + 1);
        oInput.addEventListener("input", function() {
          item.order = parseInt(this.value || "0", 10);
          updatePreview();
        });
        orderField.appendChild(oLabel);
        orderField.appendChild(oInput);
        fields.appendChild(orderField);

        // 이미지 세로 위치(posY)
        const posField = document.createElement("div");
        posField.className = "field";
        const pLabel = document.createElement("label");
        pLabel.textContent = "이미지 세로 위치(posY)";
        const pRange = document.createElement("input");
        pRange.type = "range";
        pRange.min = "0";
        pRange.max = "100";
        pRange.value = posY;
        const pVal = document.createElement("span");
        pVal.className = "value";
        pVal.textContent = posY + "%";
        pRange.addEventListener("input", function() {
          const v = parseInt(this.value, 10);
          item.posY = v;
          pVal.textContent = v + "%";
          img.style.objectPosition = "50% " + v + "%";
          updatePreview();
        });
        posField.appendChild(pLabel);
        posField.appendChild(pRange);
        posField.appendChild(pVal);
        fields.appendChild(posField);

        // 오른쪽 삭제 버튼
        const rowActions = document.createElement("div");
        rowActions.className = "row-actions";
        const delBtn = document.createElement("button");
        delBtn.className = "btn-small";
        delBtn.textContent = "삭제";
        delBtn.addEventListener("click", function() {
          if (confirm("이 eBook을 삭제할까요?")) {
            items.splice(index, 1);
            renderList();
            updatePreview();
            refreshHtmlSelect();
          }
        });
        rowActions.appendChild(delBtn);

        row.appendChild(thumb);
        row.appendChild(fields);
        row.appendChild(rowActions);

        listEl.appendChild(row);
      });

      refreshHtmlSelect();
    }

    function updatePreview() {
      const previewList = document.getElementById("previewList");
      if (!previewList) return;

      previewList.innerHTML = "";

      const rankSel = document.getElementById("previewRank");
      const myRank = rankSel ? (rankSel.value || "") : "";
      const myIdx = myRank ? RANKS.indexOf(myRank) : -1;

      let books = items.slice().filter(function(item) {
        return item.visible !== false;
      });

      if (myIdx >= 0) {
        books = books.filter(function(item) {
          let ok = true;
          if (item.rankMin) {
            const minIdx = RANKS.indexOf(item.rankMin);
            if (minIdx >= 0 && myIdx < minIdx) ok = false;
          }
          if (item.rankMax) {
            const maxIdx = RANKS.indexOf(item.rankMax);
            if (maxIdx >= 0 && myIdx > maxIdx) ok = false;
          }
          return ok;
        });
      }

      books.sort(function(a, b) {
        return (a.order || 0) - (b.order || 0);
      });

      if (!books.length) {
        const empty = document.createElement("div");
        empty.className = "preview-empty";
        empty.textContent = "노출되는 eBook이 없습니다. (노출 OFF거나 직급 범위 밖)";
        previewList.appendChild(empty);
        return;
      }

      books.forEach(function(book) {
        const card = document.createElement("div");
        card.className = "preview-card";

        const thumb = document.createElement("div");
        thumb.className = "preview-thumb";
        const img = document.createElement("img");
        img.src = book.cover || "";
        img.alt = book.title || "";
        const posY = (typeof book.posY === "number") ? book.posY : 50;
        img.style.objectPosition = "50% " + posY + "%";
        thumb.appendChild(img);

        const body = document.createElement("div");
        body.className = "preview-body";
        const t = document.createElement("div");
        t.className = "preview-body-title";
        t.textContent = book.title || "";
        const s = document.createElement("div");
        s.className = "preview-body-sub";
        s.textContent = book.subtitle || "";
        const meta = document.createElement("div");
        meta.className = "preview-meta";

        const min = book.rankMin || "제한 없음";
        const max = book.rankMax || "제한 없음";
        meta.textContent =
          "노출 범위: " + min + " ~ " + max +
          " · 순서: " + (book.order || 0);

        body.appendChild(t);
        body.appendChild(s);
        body.appendChild(meta);

        card.appendChild(thumb);
        card.appendChild(body);

        previewList.appendChild(card);
      });
    }

    function makeTextField(labelText, value, onChange) {
      const field = document.createElement("div");
      field.className = "field";
      const label = document.createElement("label");
      label.textContent = labelText;
      const input = document.createElement("input");
      input.type = "text";
      input.value = value;
      input.addEventListener("input", function() {
        onChange(this.value);
      });
      field.appendChild(label);
      field.appendChild(input);
      return field;
    }

    function makeRankField(labelText, value, onChange) {
      const field = document.createElement("div");
      field.className = "field";
      const label = document.createElement("label");
      label.textContent = labelText;
      const select = document.createElement("select");
      RANKS.forEach(function(r) {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r === "" ? "제한 없음" : r;
        if (r === (value || "")) opt.selected = true;
        select.appendChild(opt);
      });
      select.addEventListener("change", function() {
        onChange(this.value);
      });
      field.appendChild(label);
      field.appendChild(select);
      return field;
    }

    function refreshHtmlSelect() {
      const sel = document.getElementById("htmlBookSelect");
      if (!sel) return;
      const current = sel.value;

      sel.innerHTML = '<option value="">HTML 만들 eBook 선택…</option>';
      items.forEach(function(item) {
        const opt = document.createElement("option");
        opt.value = item.id || "";
        opt.textContent = (item.id || "") + " / " + (item.title || "");
        sel.appendChild(opt);
      });

      if (current) {
        sel.value = current;
      }
    }

    // 책 추가 버튼
    document.getElementById("addBtn").addEventListener("click", function() {
      const n = items.length + 1;
      items.push({
        id: "ebook-" + n,
        title: "새 eBook " + n,
        subtitle: "",
        description: "",
        cover: "",
        video: "",
        audio: "",
        link: "",
        visible: true,
        rankMin: "",
        rankMax: "",
        order: n,
        posY: 50
      });
      renderList();
      updatePreview();
    });

    // JSON 내보내기
    document.getElementById("exportBtn").addEventListener("click", function() {
      const output = { items: items };
      document.getElementById("jsonOutput").value =
        JSON.stringify(output, null, 2);
    });

    // JSON 복사
    document.getElementById("copyBtn").addEventListener("click", function() {
      const textarea = document.getElementById("jsonOutput");
      if (!textarea.value.trim()) {
        const output = { items: items };
        textarea.value = JSON.stringify(output, null, 2);
      }
      textarea.select();
      document.execCommand("copy");
      alert("JSON을 클립보드에 복사했습니다.");
    });

    // GitHub에서 ebook-config.json 열기
    document.getElementById("openGithubBtn").addEventListener("click", function() {
      window.open("https://github.com/wordycow/so.t-leader-choice/blob/main/ebook-config.json", "_blank");
    });

    // 미리보기 직급 변경
    const previewRankSel = document.getElementById("previewRank");
    if (previewRankSel) {
      previewRankSel.addEventListener("change", updatePreview);
    }

    /* ======= 선택 eBook용 HTML 템플릿 생성 ======= */

    function generateHtmlForBook(book) {
      const title = book.title || "새 eBook";
      const subtitle = book.subtitle || "";
      const cover = book.cover || "";
      const video = book.video || "";
      const audio = book.audio || "";
      const backLink = book.link && book.link.endsWith(".html")
        ? "the-unique-main.html"
        : "the-unique-main.html";

      const safeFileName = (book.id || "ebook").replace(/[^a-zA-Z0-9_-]/g, "");

      const videoSection = video ? `
      <!-- eBook 영상 섹션 -->
      <section class="chapter media-section" id="video-section">
        <h2>eBook 영상</h2>
        <video id="ebook-video-player" controls poster="${cover}">
          <source src="${video}" type="video/mp4" />
          사용 중인 브라우저에서 비디오를 재생할 수 없습니다.
        </video>
      </section>` : "";

      const audioSection = audio ? `
      <!-- 오디오북 섹션 -->
      <section class="chapter media-section" id="audio-section">
        <h2>오디오북</h2>
        <audio id="audio-player" controls>
          <source src="${audio}" type="audio/mpeg" />
          사용 중인 브라우저에서 오디오를 재생할 수 없습니다.
        </audio>
      </section>` : "";

      return `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>The Unique – ${title}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 폰트 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background-color: #020617;
      color: #E5E7EB;
      background-image: radial-gradient(circle at top, rgba(148,163,184,0.22), transparent 55%);
    }

    .scene-bg {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.45;
      z-index: 0;
      pointer-events: none;
    }

    .page-wrap {
      position: relative;
      z-index: 5;
      max-width: 960px;
      margin: 48px auto 40px;
      padding: 0 16px 40px;
    }

    .book-frame {
      border-radius: 24px;
      padding: 24px 22px 28px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(15,23,42,0.99));
      border: 1px solid rgba(234,179,8,0.9);
      box-shadow:
        0 0 24px rgba(234,179,8,0.7),
        0 32px 80px rgba(0,0,0,0.95);
    }

    .back-link {
      font-size: 12px;
      color: #FACC15;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 10px;
    }
    .back-link:hover { text-decoration: underline; }

    .book-header {
      display: flex;
      gap: 18px;
      align-items: center;
      margin-bottom: 18px;
    }

    .book-cover {
      width: 120px;
      height: 160px;
      border-radius: 12px;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 14px 30px rgba(0,0,0,0.9);
    }

    .book-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .book-title-group {
      flex: 1;
    }

    .book-title-en {
      font-family: "Cinzel","Times New Roman",serif;
      font-size: 22px;
      letter-spacing: 0.18em;
      color: #FACC15;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .book-title-ko {
      font-size: 18px;
      font-weight: 700;
      color: #F9FAFB;
      margin-bottom: 4px;
    }

    .book-sub {
      font-size: 13px;
      color: #9CA3AF;
    }

    .book-audio {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .book-audio button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(250,204,21,0.7);
      background: linear-gradient(135deg,#0f172a,#020617);
      color: #FACC15;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .book-audio button:hover {
      border-color: rgba(248,250,252,0.9);
      background: linear-gradient(135deg,#111827,#020617);
    }

    .chapter-list {
      margin-top: 10px;
      margin-bottom: 18px;
      padding: 10px 12px;
      border-radius: 14px;
      background: radial-gradient(circle at top, #020617, #020617);
      border: 1px solid rgba(30,64,118,0.9);
      font-size: 13px;
    }

    .chapter-list-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: #E5E7EB;
    }

    .chapter-list ol {
      margin: 0;
      padding-left: 18px;
    }

    .chapter-list li {
      margin: 2px 0;
      cursor: pointer;
    }
    .chapter-list li:hover { color: #FACC15; }

    .chapter {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(51,65,85,0.9);
    }

    .chapter h2 {
      font-size: 18px;
      margin: 0 0 10px;
      color: #FDE68A;
    }

    .chapter h3 {
      font-size: 15px;
      margin: 14px 0 6px;
      color: #FACC15;
    }

    .chapter p {
      font-size: 14px;
      line-height: 1.7;
      color: #E5E7EB;
      margin: 4px 0;
    }

    .chapter em {
      color: #FBBF24;
      font-style: normal;
      font-weight: 600;
    }

    .media-section {
      margin-top: 18px;
    }
    .media-section video,
    .media-section audio {
      width: 100%;
      max-width: 100%;
      border-radius: 12px;
      outline: none;
    }
  </style>
</head>
<body>
  <!-- 필요하면 배경 이미지 넣기 -->
  <!-- <img src="img/bg-unique-main.jpg" class="scene-bg" alt="" /> -->

  <div class="page-wrap">
    <div class="book-frame">
      <a href="${backLink}" class="back-link">
        ← Member Hall로 돌아가기
      </a>

      <header class="book-header">
        <div class="book-cover">
          <img src="${cover}" alt="${title} 표지" />
        </div>

        <div class="book-title-group">
          <div class="book-title-en">THE UNIQUE</div>
          <div class="book-title-ko">${title}</div>
          <div class="book-sub">${subtitle}</div>

          <div class="book-audio">
            <button type="button" id="btn-video" onclick="toggleVideo()">eBook 영상 보기</button>
            <button type="button" id="btn-audio" onclick="toggleAudio()">오디오북 재생</button>
          </div>
        </div>
      </header>

      <!-- 목차 -->
      <section class="chapter-list">
        <div class="chapter-list-title">차례</div>
        <ol>
          <li onclick="scrollToChapter('ch-1')">1. 첫 번째 챕터 제목을 여기에 적으세요</li>
          <li onclick="scrollToChapter('ch-2')">2. 두 번째 챕터 제목을 여기에 적으세요</li>
          <li onclick="scrollToChapter('ch-3')">3. 세 번째 챕터 제목을 여기에 적으세요</li>${video ? `
          <li onclick="scrollToChapter('video-section')">eBook 영상</li>` : ""}${audio ? `
          <li onclick="scrollToChapter('audio-section')">오디오북</li>` : ""}
        </ol>
      </section>

      <!-- 본문: 실제 내용은 나중에 교체 -->
      <section class="chapter" id="ch-1">
        <h2>1. 첫 번째 챕터 제목</h2>
        <p>여기에 첫 번째 챕터 내용을 작성하세요.</p>
      </section>

      <section class="chapter" id="ch-2">
        <h2>2. 두 번째 챕터 제목</h2>
        <p>여기에 두 번째 챕터 내용을 작성하세요.</p>
      </section>

      <section class="chapter" id="ch-3">
        <h2>3. 세 번째 챕터 제목</h2>
        <p>여기에 세 번째 챕터 내용을 작성하세요.</p>
      </section>
      ${videoSection}
      ${audioSection}
    </div>
  </div>

  <script>
    function scrollToChapter(id) {
      const el = document.getElementById(id);
      if (!el) return;
      const top = el.getBoundingClientRect().top + window.scrollY - 80;
      window.scrollTo({ top, behavior: "smooth" });
    }

    // eBook 영상 토글
    function toggleVideo() {
      const video = document.getElementById("ebook-video-player");
      const audio = document.getElementById("audio-player");
      const btnVideo = document.getElementById("btn-video");
      const btnAudio = document.getElementById("btn-audio");
      if (!video) return;

      if (!video.paused && !video.ended) {
        video.pause();
        btnVideo.textContent = "eBook 영상 보기";
      } else {
        if (audio && !audio.paused) {
          audio.pause();
          btnAudio.textContent = "오디오북 재생";
        }
        video.scrollIntoView({ behavior: "smooth", block: "center" });
        setTimeout(() => {
          video.play().catch(e => console.warn("비디오 자동 재생 실패:", e));
        }, 400);
        btnVideo.textContent = "영상 그만보기";
      }
    }

    // 오디오북 토글
    function toggleAudio() {
      const video = document.getElementById("ebook-video-player");
      const audio = document.getElementById("audio-player");
      const btnVideo = document.getElementById("btn-video");
      const btnAudio = document.getElementById("btn-audio");
      if (!audio) return;

      if (!audio.paused && !audio.ended) {
        audio.pause();
        btnAudio.textContent = "오디오북 재생";
      } else {
        if (video && !video.paused) {
          video.pause();
          btnVideo.textContent = "eBook 영상 보기";
        }
        audio.scrollIntoView({ behavior: "smooth", block: "center" });
        setTimeout(() => {
          audio.play().catch(e => console.warn("오디오 자동 재생 실패:", e));
        }, 400);
        btnAudio.textContent = "재생 멈춤";
      }
    }
  </script>
</body>
</html>`;
    }

    // HTML 생성 버튼
    document.getElementById("htmlBtn").addEventListener("click", function() {
      const sel = document.getElementById("htmlBookSelect");
      const id = sel.value;
      if (!id) {
        alert("HTML을 만들 eBook을 선택하세요.");
        return;
      }
      const book = items.find(function(b) { return (b.id || "") === id; });
      if (!book) {
        alert("선택한 eBook을 찾을 수 없습니다.");
        return;
      }

      const html = generateHtmlForBook(book);
      const textarea = document.getElementById("jsonOutput");
      textarea.value = html;
      textarea.scrollIntoView({ behavior: "smooth", block: "start" });
      textarea.focus();
    });
  </script>
</body>
</html>
